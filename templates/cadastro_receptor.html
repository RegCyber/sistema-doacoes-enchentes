<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Quem Precisa de Ajuda - Sistema de Doações</title>
    <link rel="stylesheet" href="../static/style.css" />
  </head>
  <body>
    <header>
      <h1>Preciso de Ajuda</h1>
      <nav>
        <ul>
          <li><a href="/">Voltar à Página Inicial</a></li>
          <li><a href="/cadastro_doador">Quero Ajudar</a></li>
          <li><a href="/achados_perdidos">Pets Perdidos</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <section class="form-section">
        <h2>Cadastre-se para Receber Ajuda</h2>
        <p>
          Preencha seus dados para receber apoio da comunidade durante as
          enchentes
        </p>

        <form id="formReceptor" onsubmit="cadastrarReceptor(event)">
          <div class="form-group">
            <h3>Dados Pessoais</h3>
            <div class="form-row">
              <div class="form-column">
                <label for="cpf">CPF *</label>
                <input
                  type="text"
                  id="cpf"
                  name="cpf"
                  required
                  placeholder="000.000.000-00"
                  maxlength="14"
                />
              </div>
              <div class="form-column">
                <label for="nome">Nome Completo *</label>
                <input type="text" id="nome" name="nome" required />
              </div>
            </div>

            <div class="form-column">
              <label for="qtde_pessoas">Quantidade de Pessoas na Casa *</label>
              <input
                type="number"
                id="qtde_pessoas"
                name="qtde_pessoas"
                required
                min="1"
                max="20"
                value="1"
              />
            </div>
          </div>

          <div class="form-group">
            <h3>Endereço</h3>
            <div class="form-row">
              <div class="form-column">
                <label for="cep">CEP *</label>
                <input
                  type="text"
                  id="cep"
                  name="cep"
                  required
                  placeholder="00000-000"
                  maxlength="9"
                />
              </div>
              <div class="form-column">
                <label for="estado">Estado *</label>
                <input
                  type="text"
                  id="estado"
                  name="estado"
                  required
                  placeholder="SP"
                  maxlength="2"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-column">
                <label for="cidade">Cidade *</label>
                <input type="text" id="cidade" name="cidade" required />
              </div>
              <div class="form-column">
                <label for="bairro">Bairro *</label>
                <input type="text" id="bairro" name="bairro" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-column">
                <label for="endereco">Endereço *</label>
                <input type="text" id="endereco" name="endereco" required />
              </div>
              <div class="form-column">
                <label for="numero">Número *</label>
                <input type="text" id="numero" name="numero" required />
              </div>
            </div>
          </div>

          <div class="form-group">
            <h3>Contato</h3>
            <div class="form-row">
              <div class="form-column">
                <label for="telefone">Telefone *</label>
                <input
                  type="text"
                  id="telefone"
                  name="telefone"
                  required
                  placeholder="(11) 99999-9999"
                />
              </div>
              <div class="form-column">
                <label for="whatsapp">WhatsApp *</label>
                <input
                  type="text"
                  id="whatsapp"
                  name="whatsapp"
                  required
                  placeholder="(11) 99999-9999"
                />
              </div>
            </div>
          </div>

          <div class="form-group">
            <h3>Condições de Retirada</h3>
            <div class="form-column">
              <label for="pode_retirar"
                >Tem condições de retirar as doações? *</label
              >
              <select id="pode_retirar" name="pode_retirar" required>
                <option value="">Selecione</option>
                <option value="true">Sim, posso retirar</option>
                <option value="false">Não, preciso que entreguem</option>
              </select>
              <small
                >Se não tiver condições, voluntários poderão entregar na sua
                residência</small
              >
            </div>
          </div>

          <div class="form-group">
            <h3>Necessidades Específicas</h3>
            <div class="form-column">
              <label for="necessidades">Itens mais urgentes (opcional)</label>
              <textarea
                id="necessidades"
                name="necessidades"
                placeholder="Ex: Roupas infantis, alimentos, colchões, medicamentos..."
                rows="3"
              ></textarea>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary">Solicitar Ajuda</button>
            <button
              type="button"
              class="btn-secondary"
              onclick="limparFormulario()"
            >
              Limpar
            </button>
          </div>
        </form>
      </section>

      <section id="confirmacao" class="hidden">
        <div class="success-message">
          <h2>Solicitação cadastrada com sucesso!</h2>
          <p>Em breve entraremos em contato para ajudar você e sua família.</p>
          <p>
            <strong>Lembre-se:</strong> Em caso de emergência, ligue para a
            Defesa Civil: 199
          </p>
          <a href="/" class="btn-primary">Voltar à Página Inicial</a>
        </div>
      </section>
    </main>

    <footer>
      <p>
        &copy; 2024 Sistema de Doações para Enchentes. Todos os direitos
        reservados.
      </p>
    </footer>

    <script>
      // Mesmas máscaras do cadastro_doador
      function aplicarMascaras() {
        const cpf = document.getElementById("cpf");
        cpf.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 11) value = value.slice(0, 11);

          if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
          }
          e.target.value = value;
        });

        const cep = document.getElementById("cep");
        cep.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 8) value = value.slice(0, 8);

          if (value.length > 5) {
            value = value.replace(/(\d{5})(\d)/, "$1-$2");
          }
          e.target.value = value;
        });

        const telefone = document.getElementById("telefone");
        const whatsapp = document.getElementById("whatsapp");

        function mascaraTelefone(e) {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 11) value = value.slice(0, 11);

          if (value.length === 11) {
            value = value.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
          } else if (value.length === 10) {
            value = value.replace(/(\d{2})(\d{4})(\d{4})/, "($1) $2-$3");
          }
          e.target.value = value;
        }

        telefone.addEventListener("input", mascaraTelefone);
        whatsapp.addEventListener("input", mascaraTelefone);

        cep.addEventListener("blur", buscarCEP);
      }

      async function buscarCEP() {
        const cep = document.getElementById("cep").value.replace(/\D/g, "");
        if (cep.length !== 8) return;

        try {
          const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
          const data = await response.json();

          if (!data.erro) {
            document.getElementById("estado").value = data.uf;
            document.getElementById("cidade").value = data.localidade;
            document.getElementById("bairro").value = data.bairro;
            document.getElementById("endereco").value = data.logradouro;
          }
        } catch (error) {
          console.error("Erro ao buscar CEP:", error);
        }
      }

      async function cadastrarReceptor(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        data.pode_retirar = data.pode_retirar === "true";
        data.qtde_pessoas = parseInt(data.qtde_pessoas);

        try {
          const response = await fetch("/api/receptores", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            document.getElementById("formReceptor").classList.add("hidden");
            document.getElementById("confirmacao").classList.remove("hidden");
          } else {
            const error = await response.json();
            alert("Erro ao cadastrar: " + error.error);
          }
        } catch (error) {
          alert("Erro de conexão. Tente novamente.");
        }
      }

      function limparFormulario() {
        document.getElementById("formReceptor").reset();
      }

      document.addEventListener("DOMContentLoaded", aplicarMascaras);
    </script>
  </body>
</html>
