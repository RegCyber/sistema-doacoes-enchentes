<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro de Doador - Sistema de Doações</title>
    <link rel="stylesheet" href="../static/style.css" />
  </head>
  <body>
    <header>
      <h1>Cadastro de Doador</h1>
      <nav>
        <ul>
          <li><a href="/">Voltar à Página Inicial</a></li>
          <li><a href="/cadastro_receptor">Preciso de Ajuda</a></li>
          <li><a href="/achados_perdidos">Pets Perdidos</a></li>
        </ul>
      </nav>
    </header>

    <main>
      <section class="form-section">
        <h2>Cadastre-se como Doador</h2>
        <p>
          Preencha os dados abaixo para oferecer ajuda às vítimas das enchentes
        </p>

        <form id="formDoador" onsubmit="cadastrarDoador(event)">
          <div class="form-group">
            <h3>Dados Pessoais</h3>
            <div class="form-row">
              <div class="form-column">
                <label for="cpf">CPF *</label>
                <input
                  type="text"
                  id="cpf"
                  name="cpf"
                  required
                  placeholder="000.000.000-00"
                  maxlength="14"
                />
              </div>
              <div class="form-column">
                <label for="nome">Nome Completo *</label>
                <input type="text" id="nome" name="nome" required />
              </div>
            </div>
          </div>

          <div class="form-group">
            <h3>Endereço</h3>
            <div class="form-row">
              <div class="form-column">
                <label for="cep">CEP *</label>
                <input
                  type="text"
                  id="cep"
                  name="cep"
                  required
                  placeholder="00000-000"
                  maxlength="9"
                />
              </div>
              <div class="form-column">
                <label for="estado">Estado *</label>
                <input
                  type="text"
                  id="estado"
                  name="estado"
                  required
                  placeholder="SP"
                  maxlength="2"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-column">
                <label for="cidade">Cidade *</label>
                <input type="text" id="cidade" name="cidade" required />
              </div>
              <div class="form-column">
                <label for="bairro">Bairro *</label>
                <input type="text" id="bairro" name="bairro" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-column">
                <label for="endereco">Endereço *</label>
                <input type="text" id="endereco" name="endereco" required />
              </div>
              <div class="form-column">
                <label for="numero">Número *</label>
                <input type="text" id="numero" name="numero" required />
              </div>
            </div>
          </div>

          <div class="form-group">
            <h3>Contato</h3>
            <div class="form-row">
              <div class="form-column">
                <label for="telefone">Telefone *</label>
                <input
                  type="text"
                  id="telefone"
                  name="telefone"
                  required
                  placeholder="(11) 99999-9999"
                />
              </div>
              <div class="form-column">
                <label for="whatsapp">WhatsApp *</label>
                <input
                  type="text"
                  id="whatsapp"
                  name="whatsapp"
                  required
                  placeholder="(11) 99999-9999"
                />
              </div>
            </div>
          </div>

          <div class="form-group">
            <h3>Informações da Doação</h3>
            <div class="form-column">
              <label for="itens_doacao">Itens para Doação *</label>
              <textarea
                id="itens_doacao"
                name="itens_doacao"
                required
                placeholder="Ex: Roupas, alimentos não perecíveis, colchões, etc."
                rows="4"
              ></textarea>
            </div>

            <div class="form-row">
              <div class="form-column">
                <label for="prazo_disponibilidade"
                  >Prazo de Disponibilidade *</label
                >
                <input
                  type="date"
                  id="prazo_disponibilidade"
                  name="prazo_disponibilidade"
                  required
                />
              </div>
              <div class="form-column">
                <label for="pode_entregar">Pode entregar os itens? *</label>
                <select id="pode_entregar" name="pode_entregar" required>
                  <option value="">Selecione</option>
                  <option value="true">Sim, posso entregar</option>
                  <option value="false">Não, preciso que retirem</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary">Cadastrar Doação</button>
            <button
              type="button"
              class="btn-secondary"
              onclick="limparFormulario()"
            >
              Limpar
            </button>
          </div>
        </form>
      </section>

      <section id="confirmacao" class="hidden">
        <div class="success-message">
          <h2>Cadastro realizado com sucesso!</h2>
          <p>
            Obrigado por sua solidariedade. Sua doação ajudará muitas pessoas.
          </p>
          <a href="/" class="btn-primary">Voltar à Página Inicial</a>
        </div>
      </section>
    </main>

    <footer>
      <p>
        &copy; 2024 Sistema de Doações para Enchentes. Todos os direitos
        reservados.
      </p>
    </footer>

    <script>
      // Máscaras para os campos
      function aplicarMascaras() {
        // Máscara para CPF
        const cpf = document.getElementById("cpf");
        cpf.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 11) value = value.slice(0, 11);

          if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d)/, "$1.$2");
            value = value.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
          }
          e.target.value = value;
        });

        // Máscara para CEP
        const cep = document.getElementById("cep");
        cep.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 8) value = value.slice(0, 8);

          if (value.length > 5) {
            value = value.replace(/(\d{5})(\d)/, "$1-$2");
          }
          e.target.value = value;
        });

        // Máscara para telefone
        const telefone = document.getElementById("telefone");
        const whatsapp = document.getElementById("whatsapp");

        function mascaraTelefone(e) {
          let value = e.target.value.replace(/\D/g, "");
          if (value.length > 11) value = value.slice(0, 11);

          if (value.length === 11) {
            value = value.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
          } else if (value.length === 10) {
            value = value.replace(/(\d{2})(\d{4})(\d{4})/, "($1) $2-$3");
          }
          e.target.value = value;
        }

        telefone.addEventListener("input", mascaraTelefone);
        whatsapp.addEventListener("input", mascaraTelefone);

        // Buscar CEP
        cep.addEventListener("blur", buscarCEP);
      }

      async function buscarCEP() {
        const cep = document.getElementById("cep").value.replace(/\D/g, "");
        if (cep.length !== 8) return;

        try {
          const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
          const data = await response.json();

          if (!data.erro) {
            document.getElementById("estado").value = data.uf;
            document.getElementById("cidade").value = data.localidade;
            document.getElementById("bairro").value = data.bairro;
            document.getElementById("endereco").value = data.logradouro;
          }
        } catch (error) {
          console.error("Erro ao buscar CEP:", error);
        }
      }

      async function cadastrarDoador(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = Object.fromEntries(formData.entries());
        data.pode_entregar = data.pode_entregar === "true";

        try {
          const response = await fetch("/api/doadores", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            document.getElementById("formDoador").classList.add("hidden");
            document.getElementById("confirmacao").classList.remove("hidden");
          } else {
            const error = await response.json();
            alert("Erro ao cadastrar: " + error.error);
          }
        } catch (error) {
          alert("Erro de conexão. Tente novamente.");
        }
      }

      function limparFormulario() {
        document.getElementById("formDoador").reset();
      }

      // Inicializar quando a página carregar
      document.addEventListener("DOMContentLoaded", aplicarMascaras);
    </script>
  </body>
</html>
